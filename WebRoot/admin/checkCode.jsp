<%@ page language="java" import="java.util.*"%>
<%@ page pageEncoding="gbk" contentType="image/jpeg" import="java.awt.*,java.awt.image.*,java.util.*,javax.imageio.*"%>

<%
String path = request.getContextPath();
String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
%>

<%!
//在给定范围内获得随机颜色
Color  getRandColor(int fc,int bc){
   Random  random=new Random();
   if(fc>255) fc=255;
   if(bc>255) bc=255;
   int r=fc+random.nextInt(bc-fc);
   int g=fc+random.nextInt(bc-fc);
   int b=fc+random.nextInt(bc-fc);
   return  new Color(r,g,b);
}
 %>
<%  
    
    response.setHeader("Pragma","No-cache");
    response.setHeader("Cache-Control","no-cache");
    response.setDateHeader("Expires",0);
     //在内存中创建图像
    int width=70, height=25;
      BufferedImage  image=new BufferedImage(width,height,BufferedImage.TYPE_INT_BGR);
     //获得图形上下文
       Graphics  g=image.getGraphics();
       //生产随机类
       Random  random=new Random();
       //设定背景
       g.setColor(getRandColor(200,250));
       g.fillRect(0,0,width,height);
       //设定字体
       g.setFont(new Font("Times New Roman",Font.PLAIN,18));
       //画边框
   
     //随机产生155条干扰线，是图像中的认证码不容易被其他程序检测到
       g.setColor(getRandColor(160,200));
        for(int i=0;i<155;i++){
       int x=random.nextInt(width);
       int y=random.nextInt(height);
       int xi=random.nextInt(12);
       int yi=random.nextInt(12);
       g.drawLine(x,y,x+xi,y+yi);
       }
       //获取随机产生的验证码
       String   sRand="";
       for(int i=0;i<4;i++){
       String  rand=String.valueOf(random.nextInt(10));
       sRand+=rand;
       //将认证码显示到图像中去
       g.setColor(new Color(20+random.nextInt(110),20+random.nextInt(110),20+random.nextInt(110)));
       //调用函数获得的颜色相同
       g.drawString(rand,13*i+6,16);
       }
       //将验证码放入seeion中
       session.setAttribute("rand",sRand);
     
       //图像生效
       g.dispose();
       //输出图像到页面
       ImageIO.write(image,"JPEG",response.getOutputStream());
       out.clear();
       out=pageContext.pushBody();
 %>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <base href="<%=basePath%>">
    
    <title>My JSP 'checkCode.JSP' starting page</title>
    
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">
	<meta http-equiv="expires" content="0">    
	<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
	<meta http-equiv="description" content="This is my page">
	<!--
	<link rel="stylesheet" type="text/css" href="styles.css">
	-->

  </head>
  
  <body>
    This is my JSP page. <br>
  </body>
</html>
